name: Auto Version Bump

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'package.json'
      - 'package-lock.json'

env:
  NODE_VERSION: '18'

jobs:
  version-bump:
    name: Semantic Version Bump
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip version]')"

    outputs:
      version-changed: ${{ steps.bump.outputs.version-changed }}
      new-version: ${{ steps.bump.outputs.new-version }}
      version-type: ${{ steps.bump.outputs.version-type }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: npm ci

    - name: Analyze commit messages
      id: analyze
      run: |
        echo "Analyzing commit messages for version bump..."

        # Get commits since last version tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

        if [ -z "$LAST_TAG" ]; then
          # If no tags exist, check all commits
          COMMITS=$(git log --pretty=format:"%s" --no-merges)
        else
          # Get commits since last tag
          COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s" --no-merges)
        fi

        echo "Commits to analyze:"
        echo "$COMMITS"
        echo ""

        # Initialize bump type
        BUMP_TYPE="none"

        # Check for breaking changes (major version)
        if echo "$COMMITS" | grep -qE "^[a-zA-Z]+(\(.+\))?!:" || \
           echo "$COMMITS" | grep -qi "BREAKING CHANGE"; then
          BUMP_TYPE="major"
          echo "ðŸš¨ Breaking changes detected - major version bump required"
        # Check for features (minor version)
        elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
          BUMP_TYPE="minor"
          echo "âœ¨ New features detected - minor version bump required"
        # Check for fixes (patch version)
        elif echo "$COMMITS" | grep -qE "^fix(\(.+\))?:"; then
          BUMP_TYPE="patch"
          echo "ðŸ› Bug fixes detected - patch version bump required"
        # Check for other conventional commit types that should trigger patch
        elif echo "$COMMITS" | grep -qE "^(perf|refactor|style|test|docs|chore)(\(.+\))?:"; then
          BUMP_TYPE="patch"
          echo "ðŸ”§ Code improvements detected - patch version bump required"
        else
          echo "â„¹ï¸ No conventional commits found - no version bump needed"
        fi

        echo "bump-type=$BUMP_TYPE" >> $GITHUB_OUTPUT

    - name: Bump version
      id: bump
      run: |
        BUMP_TYPE="${{ steps.analyze.outputs.bump-type }}"

        if [ "$BUMP_TYPE" = "none" ]; then
          echo "version-changed=false" >> $GITHUB_OUTPUT
          echo "No version bump needed"
          exit 0
        fi

        # Get current version
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "Current version: $CURRENT_VERSION"

        # Bump version using npm
        case $BUMP_TYPE in
          "major")
            NEW_VERSION=$(npm version major --no-git-tag-version)
            ;;
          "minor")
            NEW_VERSION=$(npm version minor --no-git-tag-version)
            ;;
          "patch")
            NEW_VERSION=$(npm version patch --no-git-tag-version)
            ;;
        esac

        # Remove 'v' prefix from npm version output
        NEW_VERSION=${NEW_VERSION#v}

        echo "New version: $NEW_VERSION"
        echo "version-changed=true" >> $GITHUB_OUTPUT
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "version-type=$BUMP_TYPE" >> $GITHUB_OUTPUT


    - name: Commit version bump
      if: steps.bump.outputs.version-changed == 'true'
      run: |
        NEW_VERSION="${{ steps.bump.outputs.new-version }}"
        VERSION_TYPE="${{ steps.bump.outputs.version-type }}"

        # Add package files
        git add package.json package-lock.json

        # Create commit message
        COMMIT_MSG="chore(release): bump version to v$NEW_VERSION

        - Version type: $VERSION_TYPE
        - Auto-generated by GitHub Actions
        - Based on conventional commit analysis

        [skip version]"

        # Commit changes
        git commit -m "$COMMIT_MSG"

    - name: Create and push tag
      if: steps.bump.outputs.version-changed == 'true'
      run: |
        NEW_VERSION="${{ steps.bump.outputs.new-version }}"

        # Create annotated tag
        git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION

        Auto-generated release based on conventional commits.

        Version type: ${{ steps.bump.outputs.version-type }}
        Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        "

        # Push changes and tag
        git push origin main
        git push origin "v$NEW_VERSION"

        echo "âœ… Tagged and pushed v$NEW_VERSION"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: version-bump
    if: needs.version-bump.outputs.version-changed == 'true'

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: v${{ needs.version-bump.outputs.new-version }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Generate release notes
      id: release-notes
      run: |
        NEW_VERSION="${{ needs.version-bump.outputs.new-version }}"
        VERSION_TYPE="${{ needs.version-bump.outputs.version-type }}"

        # Get commits for release notes
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -z "$LAST_TAG" ]; then
          COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges HEAD^)
        else
          COMMITS=$(git log $LAST_TAG..HEAD^ --pretty=format:"- %s (%h)" --no-merges)
        fi

        # Categorize commits
        FEATURES=$(echo "$COMMITS" | grep "^- feat" || echo "")
        FIXES=$(echo "$COMMITS" | grep "^- fix" || echo "")
        BREAKING=$(echo "$COMMITS" | grep "BREAKING CHANGE\|!" || echo "")
        OTHER=$(echo "$COMMITS" | grep -v "^- feat\|^- fix" || echo "")

        # Create release notes
        cat > RELEASE_NOTES.md << EOF
        ## ðŸš€ Autocomplete Commands Line v$NEW_VERSION

        **Release Type**: ${VERSION_TYPE^} version bump
        **Release Date**: $(date +%Y-%m-%d)

        EOF

        # Add breaking changes section
        if [ -n "$BREAKING" ]; then
          cat >> RELEASE_NOTES.md << EOF
        ### âš ï¸ Breaking Changes
        $BREAKING

        EOF
        fi

        # Add features section
        if [ -n "$FEATURES" ]; then
          cat >> RELEASE_NOTES.md << EOF
        ### âœ¨ New Features
        $FEATURES

        EOF
        fi

        # Add fixes section
        if [ -n "$FIXES" ]; then
          cat >> RELEASE_NOTES.md << EOF
        ### ðŸ› Bug Fixes
        $FIXES

        EOF
        fi

        # Add other changes
        if [ -n "$OTHER" ]; then
          cat >> RELEASE_NOTES.md << EOF
        ### ðŸ”§ Other Changes
        $OTHER

        EOF
        fi

        # Add installation instructions
        cat >> RELEASE_NOTES.md << EOF
        ### ðŸ“¦ Installation

        \`\`\`bash
        # Clone the repository
        git clone https://github.com/MaxiGarcia13/autocomplete-commands-line.git
        cd autocomplete-commands-line

        # Checkout this version
        git checkout v$NEW_VERSION

        # Install dependencies
        npm install

        # Setup autocomplete (add to ~/.zshrc)
        export AUTOCOMPLETE_COMMANDS_LINE_PATH="\$(pwd)"
        source "\$AUTOCOMPLETE_COMMANDS_LINE_PATH/src/command-line-interfaces/zsh.sh"
        \`\`\`

        ### ðŸ”„ Update from Previous Version

        \`\`\`bash
        cd autocomplete-commands-line
        git fetch origin
        git checkout v$NEW_VERSION
        npm install
        source ~/.zshrc
        \`\`\`

        ### âš¡ Performance

        - Smart caching system with 24-hour expiration
        - 99% faster responses for cached commands
        - Support for 40+ popular development tools

        ---

        **Full Changelog**: https://github.com/MaxiGarcia13/autocomplete-commands-line/compare/$LAST_TAG...v$NEW_VERSION
        EOF

        echo "Generated release notes for v$NEW_VERSION"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.version-bump.outputs.new-version }}
        name: Release v${{ needs.version-bump.outputs.new-version }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: ${{ contains(needs.version-bump.outputs.new-version, '-') }}
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [version-bump, create-release]
    if: needs.version-bump.outputs.version-changed == 'true'

    steps:
    - name: Success notification
      run: |
        NEW_VERSION="${{ needs.version-bump.outputs.new-version }}"
        VERSION_TYPE="${{ needs.version-bump.outputs.version-type }}"

        echo "## ðŸŽ‰ Version Bump Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Release Details" >> $GITHUB_STEP_SUMMARY
        echo "- **New Version**: v$NEW_VERSION" >> $GITHUB_STEP_SUMMARY
        echo "- **Bump Type**: $VERSION_TYPE" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Created**: âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag Pushed**: âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Release Page](https://github.com/MaxiGarcia13/autocomplete-commands-line/releases/tag/v$NEW_VERSION)" >> $GITHUB_STEP_SUMMARY
        echo "- [Changelog](https://github.com/MaxiGarcia13/autocomplete-commands-line/releases/tag/v$NEW_VERSION)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Installation Command" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "git checkout v$NEW_VERSION && npm install" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  no-version-bump:
    name: No Version Bump
    runs-on: ubuntu-latest
    needs: version-bump
    if: needs.version-bump.outputs.version-changed == 'false'

    steps:
    - name: No bump notification
      run: |
        echo "## â„¹ï¸ No Version Bump Required" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "No conventional commits found that require a version bump." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Conventional Commit Types That Trigger Bumps:" >> $GITHUB_STEP_SUMMARY
        echo "- \`fix:\` â†’ patch version (0.0.X)" >> $GITHUB_STEP_SUMMARY
        echo "- \`feat:\` â†’ minor version (0.X.0)" >> $GITHUB_STEP_SUMMARY
        echo "- \`BREAKING CHANGE\` or \`!\` â†’ major version (X.0.0)" >> $GITHUB_STEP_SUMMARY
        echo "- \`perf:\`, \`refactor:\`, \`style:\`, \`test:\`, \`docs:\`, \`chore:\` â†’ patch version" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### To Skip Version Bumping:" >> $GITHUB_STEP_SUMMARY
        echo "Add \`[skip version]\` to your commit message." >> $GITHUB_STEP_SUMMARY
